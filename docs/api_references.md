# API References

This document provides details on the APIs exposed by the different services within the AI Scraping Defense Stack.

---

## 1. Nginx

* **Role:** Reverse Proxy, Edge Filtering
* **Exposed Ports (Defaults):** 80 (HTTP), 443 (HTTPS)
* **Key Internal Locations:**
  * `/` (Default): Proxies to the real backend application (defined by `REAL_BACKEND_HOST`) after passing Lua checks.
  * `/admin/`: Proxies to the Admin UI service.
  * `/api/tarpit`: **Internal location.** Requests are redirected here by `detect_bot.lua` for suspicious traffic. Proxies to the Tarpit API service.
  * `/docs/archives/`: Serves static ZIP files generated by the Archive Rotator.

---

## 2. Tarpit API (`tarpit_api`)

* **Role:** Handle suspicious requests, slow down bots, generate fake content, escalate metadata.
* **Default Internal Port:** 8001
* **Framework:** FastAPI
* **Endpoints:**
  * **`GET /tarpit/{path:path}`**
    * **Description:** Main tarpit endpoint accessed via internal Nginx redirect. Logs the hit, flags the IP (Redis DB 1), checks the hop limit (Redis DB 4), escalates metadata to the Escalation Engine, generates deterministic fake content using PostgreSQL, and streams the response slowly.
    * **Path Parameter:** `path` captures the original path requested by the client.
    * **Responses:**
      * `200 OK`: Streams HTML content slowly. Content is deterministically generated based on path hash and system seed.
      * `403 Forbidden`: Returned immediately (non-streaming) if the client IP exceeds the configured `TAR_PIT_MAX_HOPS` limit within the `TAR_PIT_HOP_WINDOW_SECONDS` window. The IP is also added to the blocklist (Redis DB 2).
    * **Authentication:** None (accessed internally).
  * **`GET /health`**
    * **Description:** Basic health check endpoint. Verifies Redis connectivity for hops and blocklist DBs.
    * **Responses:** `200 OK` with JSON status.
  * **`GET /`**
    * **Description:** Root endpoint providing basic service info.
    * **Responses:** `200 OK` with JSON message.

---

## 3. Escalation Engine (`escalation_engine`)

* **Role:** Analyze suspicious request metadata, score requests, trigger further actions.
* **Default Internal Port:** 8003
* **Framework:** FastAPI
* **Endpoints:**
  * **`POST /escalate`**
    * **Description:** Receives request metadata from the Tarpit API. Performs frequency analysis (Redis DB 3), heuristic checks, runs the Random Forest model, and optionally calls external APIs (IP reputation, LLM, etc.). If deemed malicious, forwards data to the AI Service webhook.
    * **Request Body:** JSON object containing request details (IP, UA, headers, path, etc.).
    * **Responses:**
      * `200 OK`: Successfully processed the request (doesn't necessarily mean it wasn't malicious, just that processing finished).
      * `422 Unprocessable Entity`: Invalid request body format.
      * `5xx Server Error`: Internal error during processing.
    * **Authentication:** None (intended for internal calls).
  * **`GET /health`**
    * **Description:** Basic health check endpoint.
    * **Responses:** `200 OK` with JSON status.
  * **`GET /`**
    * **Description:** Root endpoint providing basic service info.
    * **Responses:** `200 OK` with JSON message.

---

## 4. AI Service (`ai_service`)

* **Role:** Manage blocklist, dispatch alerts, optionally report to community lists.
* **Default Internal Port:** 8000
* **Framework:** FastAPI
* **Endpoints:**
  * **`POST /analyze`**
    * **Description:** Receives webhook data for confirmed malicious requests from the Escalation Engine. Adds the source IP to the Redis blocklist (DB 2) and triggers configured alerts/reporting.
    * **Request Body:** JSON object containing details of the malicious request and reason for blocking.
    * **Responses:**
      * `200 OK`: Webhook received and processed.
      * `422 Unprocessable Entity`: Invalid request body format.
      * `5xx Server Error`: Internal error during processing (e.g., Redis connection issue, alert failure).
    * **Authentication:** None (intended for internal calls).
  * **`GET /health`**
    * **Description:** Basic health check endpoint. Verifies Redis connectivity.
    * **Responses:** `200 OK` with JSON status.
  * **`GET /`**
    * **Description:** Root endpoint providing basic service info.
    * **Responses:** `200 OK` with JSON message.

---

## 5. Admin UI (`admin_ui`)

* **Role:** Display real-time system metrics.
* **Default Internal Port:** 5002
* **Framework:** Flask
* **Endpoints:**
  * **`GET /`** (Accessed via Nginx at `/admin/`)
    * **Description:** Serves the HTML dashboard page.
    * **Responses:** `200 OK` (HTML).
  * **`GET /metrics`**
    * **Description:** Returns current metrics data as JSON. Fetched by the dashboard's JavaScript.
    * **Responses:** `200 OK` (JSON containing metrics from `metrics.py`).

---
